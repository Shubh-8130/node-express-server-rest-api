pipeline {
    agent any
        stages {
            stage('Build and Deploy') {
                steps {
                    // Connect to the server using SSH and execute commands
                    script {
                        // Execute commands on the remote server
                        sh """
                            ssh -i /Users/shubhamsharma/jenkins/my-key-terr.pem ubuntu@54.156.64.233 '
                            cd ~
                            git clone https://github.com/Shubh-8130/node-express-server-rest-api.git
                            cd ~/node-express-server-rest-api
                            sudo apt update -y
                            sudo apt install nodejs npm -y
                            npm install -y
                            npm update -y
                            '
                        """
                    }
                }
            }
            stage('Start Application') {
                steps {
                    script {
                        def npmStartOutput = sh(script: 'npm start', returnStatus: true).trim()

                        // Check if the output contains a specific success message
                        if (npmStartOutput.contains('Example app listening on port 3000!')) {
                            currentBuild.result = 'SUCCESS'
                        } else {
                            currentBuild.result = 'FAILURE'
                            error("npm start failed with the following output: ${npmStartOutput}")
                        }
                    }
                }
            }
        }
    }
