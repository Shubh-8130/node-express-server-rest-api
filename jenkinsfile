pipeline {
    agent any
    stages {
        stage('Build and Deploy') {
            steps {
                // Connect to the server using SSH and execute commands
                script {
                    // Execute commands on the remote server
                    sh """
                        ssh -i /Users/shubhamsharma/jenkins/my-key-terr.pem ubuntu@54.224.72.103 '
                            # Define the directory name and repository URL
                            directory_name=node-express-server-rest-api
                            repository_url=https://github.com/Shubh-8130/node-express-server-rest-api.git
                            cd ~
                            # Check if the directory exists
                            if [ -d "$directory_name" ]; then
                                # If the directory exists, delete it
                                echo "Deleting existing directory: $directory_name"
                                rm -rf "$directory_name"
                            fi

                            # Clone the repository
                            echo "Cloning repository into $directory_name"
                            git clone "$repository_url" "$directory_name"

                            # Additional commands or operations can be added here if needed

                            echo "Process completed successfully."
                            git clone https://github.com/Shubh-8130/node-express-server-rest-api.git
                            cd ~/node-express-server-rest-api
                            sudo apt update -y
                            sudo apt install nodejs npm -y
                            npm install -y
                            npm update -y
                            npm start
                            sleep 10  # Wait for the Node.js process to start (adjust as needed)
                        '
                    """
                }
                script {
                    // Check if the node process is running
                    def nid = sh(script: 'ssh -i /Users/shubhamsharma/jenkins/my-key-terr.pem ubuntu@54.156.64.233 "pgrep -f \\"node .*npm start\\""', returnStdout: true).trim()

                    if (nid && nid != '0') {
                        currentBuild.result = 'SUCCESS'
                    } else {
                        error 'Node.js process not running or invalid process ID.'
                    }
                }
            }
        }
    }
}


